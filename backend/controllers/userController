// const bcrypt = require("bcrypt");
const { v4: uuidv4 } = require("uuid");

exports.registerUser = (req, res) => {
  const {
    name,
    user_name,
    password,
    email,
    phone_number,
    address,
    ward_no,
    city,
    profile_pic,
  } = req.body;

  if (
    !name ||
    !user_name ||
    !password ||
    !email ||
    !phone_number ||
    !address ||
    !ward_no ||
    !city ||
    !profile_pic
  ) {
    return res
      .status(400)
      .json({ message: "Please provide all required fields." });
  }

  // Insert the new user into the database
  const pool = req.pool;
  const userId = uuidv4();

  const query = `
    INSERT INTO users (
      user_id, name, user_name, password, email, phone_number, address, ward_no, city, profile_pic
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
  `;
  const values = [
    userId,
    name,
    user_name,
    password,
    email,
    phone_number,
    address,
    ward_no,
    city,
    profile_pic,
  ];

  pool.query(query, values, (error, results) => {
    if (error) {
      console.error("Error registering user:", error);
      if (!res.headersSent) {
        return res
          .status(500)
          .json({ message: "Error registering user.", error });
      }
    } else {
      if (!res.headersSent) {
        return res
          .status(201)
          .json({ message: "User registered successfully." });
      }
    }
  });
};

exports.getUserInfo = (req, res) => {
  const { userId } = req.params;

  // Validate the userId
  if (!userId) {
    return res.status(400).json({ message: "User ID is required." });
  }

  // Query the user info from the database
  const pool = req.pool;

  const query = `
    SELECT user_id, name, user_name, email, phone_number, address, ward_no, city, profile_pic
    FROM users
    WHERE user_id = ?
  `;

  pool.query(query, [userId], (error, results) => {
    if (error) {
      console.error("Error retrieving user info:", error);
      if (!res.headersSent) {
        return res
          .status(500)
          .json({ message: "Error retrieving user info.", error });
      }
    } else if (results.length === 0) {
      if (!res.headersSent) {
        return res.status(404).json({ message: "User not found." });
      }
    } else {
      if (!res.headersSent) {
        return res.status(200).json(results[0]);
      }
    }
  });
};

exports.postTask = (req, res) => {
  const { user_id, post } = req.body;

  // Validate request body
  if (!user_id || !post.trim()) {
    return res
      .status(400)
      .json({ message: "Please provide all required fields." });
  }

  const pool = req.pool; // Assuming the pool is provided in req
  const postId = uuidv4();
  let selected_status = 0;

  const query = `
    INSERT INTO post (
      post_id, user_id, post, selected_status
    ) VALUES (?, ?, ?, ?)
  `;
  const values = [postId, user_id, post, selected_status];

  pool.query(query, values, (error, results) => {
    if (error) {
      console.error("Error posting post:", error);
      return res.status(500).json({ message: "Error posting post." });
    } else {
      return res
        .status(201)
        .json({ message: "User Post posted successfully." });
    }
  });
};

exports.getPostData = (req, res) => {
  const pool = req.pool;
  pool.getConnection((err, connection) => {
    if (err) throw err;
    // console.log(`connected as id ${connection.threadId}`);

    connection.query("Select * from post", (err, rows) => {
      connection.release();

      if (!err) {
        res.status(200).json({
          status: "success",
          results: rows.length,
          data: {
            rows,
          },
          // data,
        });
      } else {
        console.log(err);
      }
    });
  });
};
